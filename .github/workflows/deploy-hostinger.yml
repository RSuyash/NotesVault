name: Deploy to Hostinger

on:
  push:
    branches:
      - master # Or your main deployment branch (e.g., main)

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20' # Use an appropriate LTS version

    - name: Install Frontend Dependencies
      run: npm ci
      working-directory: ./notesvault-react-mvp

    - name: Build React App # Output goes to notesvault-react-mvp/dist
      run: npm run build
      working-directory: ./notesvault-react-mvp

    - name: Copy .htaccess to dist folder # Add .htaccess to the build output
      run: cp .htaccess ./notesvault-react-mvp/dist/

    - name: Create Production Config for API
      run: |
        echo "<?php" > api/config.prod.php
        echo "// Production Configuration (api/config.prod.php) - Generated by GitHub Actions" >> api/config.prod.php
        echo "// This file is loaded by config.php ONLY on the production server." >> api/config.prod.php
        echo "" >> api/config.prod.php
        echo "// --- Production Database Configuration ---" >> api/config.prod.php
        echo "define('DB_HOST', '${{ secrets.DB_HOST }}');" >> api/config.prod.php
        echo "define('DB_USER', '${{ secrets.DB_USER }}');" >> api/config.prod.php
        echo "define('DB_PASS', '${{ secrets.DB_PASS }}');" >> api/config.prod.php
        echo "define('DB_NAME', '${{ secrets.DB_NAME }}');" >> api/config.prod.php
        echo "" >> api/config.prod.php
        echo "// --- Production JWT Configuration ---" >> api/config.prod.php
        echo "define('JWT_SECRET_KEY', '${{ secrets.JWT_SECRET_KEY }}');" >> api/config.prod.php
        echo "" >> api/config.prod.php
        echo "// --- JWT Expiration Time (Using default from config.php unless overridden here) ---" >> api/config.prod.php
        echo "// define('JWT_EXPIRATION_TIME', 3600);" >> api/config.prod.php
        echo "" >> api/config.prod.php
        echo "?>" >> api/config.prod.php
      shell: bash

    - name: Deploy Built Frontend + .htaccess to Hostinger
      uses: SamKirkland/FTP-Deploy-Action@v4.3.4
      with:
        server: ${{ secrets.HOSTINGER_FTP_SERVER }}
        username: ${{ secrets.HOSTINGER_FTP_USERNAME }}
        password: ${{ secrets.HOSTINGER_FTP_PASSWORD }}
        protocol: ftp # Or ftps, sftp
        port: 21 # Or 22 for SFTP
        local-dir: ./notesvault-react-mvp/dist/ # Source: React build output (includes .htaccess now)
        server-dir: /public_html/ # Destination: Server root
        exclude: |
          **/.git*
          **/.git*/**

    - name: Deploy API to Hostinger (excluding logs, generated config)
      uses: SamKirkland/FTP-Deploy-Action@v4.3.4
      with:
        server: ${{ secrets.HOSTINGER_FTP_SERVER }}
        username: ${{ secrets.HOSTINGER_FTP_USERNAME }}
        password: ${{ secrets.HOSTINGER_FTP_PASSWORD }}
        protocol: ftp # Or ftps, sftp
        port: 21 # Or 22 for SFTP
        local-dir: ./api/ # Source: API directory
        server-dir: /public_html/api/ # Destination: API subdir on server
        exclude: | # Exclude patterns relative to local-dir (./api/)
          **/config.prod.php
          **/logs/**
          **/.git*
          **/.git*/**
